<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sidebar-bg: #2c3e50;
      --sidebar-text: #ecf0f1;
      --sidebar-hover-bg: #34495e;
      --sidebar-active-border: #3498db;
      --content-bg: #f4f6f9; 
      --card-bg: #ffffff;
      --card-border-radius: 0.6rem; 
      --card-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --text-primary-dark: #1a252f; 
      --text-secondary-dark: #52616b; 
      --primary-accent: #3498db;
      --bs-success-rgb: 40, 167, 69;
      --bs-danger-rgb: 220, 53, 69;
      --bs-warning-rgb: 255, 193, 7;
      --bs-info-rgb: 23, 162, 184;
      --bs-primary-rgb: 52, 152, 219;
    }
    body {
      background-color: var(--content-bg);
      overflow-x: hidden;
      font-family: 'Roboto', sans-serif;
      color: var(--text-primary-dark);
      font-size: 0.95rem;
    }
    .sidebar {
      height: 100vh; background-color: var(--sidebar-bg); color: var(--sidebar-text);
      padding-top: 0; position: fixed; left: 0; top: 0; bottom: 0; width: 260px; 
      z-index: 1050; transition: transform 0.3s ease-in-out; box-shadow: 2px 0 8px rgba(0,0,0,0.15);
    }
    .sidebar .sidebar-header {
      padding: 1.25rem 1.5rem; font-size: 1.5rem; font-weight: 700; color: #fff;
      background-color: rgba(0,0,0,0.15); border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; align-items: center;
    }
    .sidebar .sidebar-header i { margin-right: 0.85rem; }
    .sidebar ul { list-style: none; padding-left: 0; margin-top: 1rem; }
    .sidebar ul li {
      padding: 0.9rem 1.5rem; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
      display: flex; align-items: center; border-left: 4px solid transparent; font-size: 0.9rem;
    }
    .sidebar ul li:hover, .sidebar ul li.active-link {
      background-color: var(--sidebar-hover-bg); color: #fff; cursor: pointer;
      border-left-color: var(--sidebar-active-border);
    }
    .sidebar ul li i { margin-right: 1rem; font-size: 1.1rem; width: 22px; text-align: center; }
    .content {
      padding: 2rem; margin-left: 260px; width: calc(100% - 260px);
      transition: margin-left 0.3s ease-in-out;
    }
    .main-section { display: none; }
    .main-section.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card {
      border: 1px solid #e3e6f0; 
      border-radius: var(--card-border-radius);
      box-shadow: var(--card-shadow); margin-bottom: 1.75rem; background-color: var(--card-bg);
    }
    .card-header {
      background-color: #f8f9fc; 
      border-bottom: 1px solid #e3e6f0; font-weight: 600;
      padding: 0.9rem 1.25rem; color: var(--primary-accent);
    }
    .card-title { font-weight: 500; margin-bottom: 0.25rem; font-size: 1.1rem;}
    .card-subtitle { color: var(--text-secondary-dark); font-size: 0.85rem; }

    .stat-card .card-body { padding: 1.25rem; }
    .stat-card .stat-main { display: flex; align-items: center; }
    .stat-card .stat-icon-bg {
      font-size: 1.8rem; width: 50px; height: 50px; border-radius: var(--card-border-radius);
      display: flex; align-items: center; justify-content: center; color: #fff; margin-right: 1rem;
    }
    .stat-card .stat-info .stat-value { font-size: 1.6rem; font-weight: 700; line-height: 1.2; }
    .stat-card .stat-info .stat-label { font-size: 0.8rem; color: var(--text-secondary-dark); text-transform: uppercase; }

    .bg-soft-primary { background-color: rgba(var(--bs-primary-rgb), 0.1); }
    .bg-soft-success { background-color: rgba(var(--bs-success-rgb), 0.1); }
    .bg-soft-warning { background-color: rgba(var(--bs-warning-rgb), 0.1); }
    .bg-soft-info   { background-color: rgba(var(--bs-info-rgb), 0.1); }
    .text-primary { color: var(--primary-accent) !important; }

    .overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(44,62,80,0.7); z-index: 1040; 
    }
    .mobile-header {
      display: none; background-color: var(--sidebar-bg); color: white;
      padding: 0.75rem 1rem; position: sticky; top: 0; z-index: 1060; align-items: center;
    }
    .mobile-header button { background: none; border: none; color: white; font-size: 1.75rem; }
    .mobile-header .app-title { font-size: 1.2rem; font-weight: 600; }

    @media (max-width: 992px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.show { transform: translateX(0); }
      .overlay.show { display: block; }
      .content { margin-left: 0; width: 100%; padding: 1.5rem 1rem; }
      .mobile-header { display: flex; }
      .stat-card .stat-info .stat-value { font-size: 1.4rem; }
    }
    .table-responsive { overflow-x: auto; }
    .user-select-all { user-select: all; }
    .chart-container { position: relative; min-height: 300px; width: 100%; }
    .form-control, .form-select { font-size: 0.875rem; border-radius: 0.3rem; }
    .btn { font-size: 0.875rem; border-radius: 0.3rem; padding: 0.4rem 0.8rem; }
    .modal-xl { max-width: 1140px; }
    .badge { font-size: 0.7rem; padding: 0.35em 0.55em; font-weight: 500; }
    .list-group-item { padding: 0.7rem 1rem; font-size: 0.9rem; }
    .sticky-top { z-index: 100; }
    .data-table th { font-weight: 500; font-size: 0.85rem; text-transform: uppercase; color: var(--text-secondary-dark); }
    .data-table td { font-size: 0.875rem; vertical-align: middle; }
    .page-title {
        font-size: 1.6rem; font-weight: 500; margin-bottom: 1.75rem; display: flex; align-items: center;
        color: var(--text-primary-dark);
    }
    .page-title i { margin-right: 0.75rem; color: var(--primary-accent); font-size: 1.5rem; }
    .pagination .page-link { font-size: 0.85rem; padding: 0.4rem 0.75rem; }
    .form-control-sm { font-size: 0.8rem !important; }
    .form-select-sm { font-size: 0.8rem !important; }
  </style>
</head>
<body>

<div class="mobile-header">
  <button onclick="toggleSidebar()" class="me-2"><i class="bi bi-list"></i></button>
  <span class="app-title">Admin Panel</span>
</div>
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="d-flex">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header"><i class="bi bi-shield-shaded"></i>Admin Panel</div>
    <ul>
      <li onclick="showSection('dashboard')" class="active-link" id="nav-dashboard"><i class="bi bi-speedometer2"></i>Dashboard</li>
      <li onclick="showSection('users')" id="nav-users"><i class="bi bi-people"></i>Manajemen User</li>
      <li onclick="showSection('transaksi')" id="nav-transaksi"><i class="bi bi-bar-chart-line"></i>Laporan Transaksi</li>
      <li onclick="showSection('globalHistory')" id="nav-globalHistory"><i class="bi bi-archive"></i>Global History</li>
      <li onclick="logout()"><i class="bi bi-box-arrow-right"></i>Logout</li>
    </ul>
  </div>

  <div class="content">
    <div id="dashboard" class="main-section active">
      <h3 class="page-title"><i class="bi bi-speedometer2"></i>Dashboard Overview</h3>
      <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="stat-main">
                        <div class="stat-icon-bg bg-primary"><i class="bi bi-people-fill"></i></div>
                        <div class="stat-info ms-2">
                            <p class="stat-value" id="totalUsersCount">0</p>
                            <p class="stat-label">Total Users</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="stat-main">
                        <div class="stat-icon-bg bg-success"><i class="bi bi-person-check-fill"></i></div>
                        <div class="stat-info ms-2">
                            <p class="stat-value" id="verifiedUsersCount">0</p>
                            <p class="stat-label">Verified Users</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="stat-main">
                        <div class="stat-icon-bg bg-warning"><i class="bi bi-person-x-fill"></i></div>
                        <div class="stat-info ms-2">
                            <p class="stat-value" id="unverifiedUsersCount">0</p>
                            <p class="stat-label">Unverified Users</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="stat-main">
                         <div class="stat-icon-bg bg-info"><i class="bi bi-wallet2"></i></div>
                         <div class="stat-info ms-2">
                            <p class="stat-value" id="totalSaldoAllUsers">Rp 0</p>
                            <p class="stat-label">Total Saldo Users</p>
                        </div>
                    </div>
                </div>
            </div>
          </div>
      </div>
    </div>

    <div id="users" class="main-section">
      <h3 class="page-title"><i class="bi bi-people"></i>Manajemen Pengguna</h3>
        <div class="card">
            <div class="card-header">
                Daftar Pengguna Sistem
            </div>
            <div class="card-body">
                <div class="row mb-3 gy-2">
                    <div class="col-lg-8 col-md-7">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="userSearchInput" class="form-control form-control-sm" placeholder="Cari username, nama, atau email...">
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-5">
                        <select id="userRoleFilter" class="form-select form-select-sm">
                            <option value="">Semua Role</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                            <option value="reseller">Reseller</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle data-table">
                    <thead class="table-light">
                        <tr>
                        <th>#</th><th>Nama Lengkap</th><th>Username & Saldo</th>
                        <th>Email</th><th>Role</th><th>Verifikasi</th><th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody"></tbody>
                    </table>
                </div>
                <div id="userTablePagination" class="mt-3 d-flex justify-content-center"></div>
            </div>
        </div>
    </div>

    <div id="transaksi" class="main-section">
      <h3 class="page-title"><i class="bi bi-bar-chart-line"></i>Laporan Transaksi</h3>
        <div class="row mb-4">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        Total Deposit Sukses
                        <small class="text-muted">(7 Hari Terakhir)</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="depositChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                     <div class="card-header d-flex justify-content-between align-items-center">
                        Total Order Sukses
                        <small class="text-muted">(7 Hari Terakhir)</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="orderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      <div class="mb-5">
        <h4 class="mb-3 fw-normal fs-5"><i class="bi bi-calendar-day me-2"></i>Ringkasan Hari Ini</h4>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card stat-card h-100 bg-soft-info"><div class="card-body"><div class="stat-main"><div class="stat-icon-bg bg-info"><i class="bi bi-arrow-down-circle-fill"></i></div><div class="stat-info ms-2"><p class="stat-value text-info" id="depositToday">Rp 0</p><p class="stat-label">Deposit Sukses</p></div></div></div></div>
          </div>
          <div class="col-md-6">
            <div class="card stat-card h-100 bg-soft-warning"><div class="card-body"><div class="stat-main"><div class="stat-icon-bg bg-warning"><i class="bi bi-cart-check-fill"></i></div><div class="stat-info ms-2"><p class="stat-value text-warning" id="orderToday">Rp 0</p><p class="stat-label">Order Sukses</p></div></div></div></div>
          </div>
        </div>
      </div>

      <div>
        <h4 class="mb-3 fw-normal fs-5"><i class="bi bi-calendar-week me-2"></i>Ringkasan Minggu Ini (7 Hari Terakhir)</h4>
        <div class="row g-3">
          <div class="col-md-6">
             <div class="card stat-card h-100 bg-soft-info"><div class="card-body"><div class="stat-main"><div class="stat-icon-bg bg-info"><i class="bi bi-piggy-bank-fill"></i></div><div class="stat-info ms-2"><p class="stat-value text-info" id="depositThisWeek">Rp 0</p><p class="stat-label">Deposit Sukses</p></div></div></div></div>
          </div>
          <div class="col-md-6">
            <div class="card stat-card h-100 bg-soft-warning"><div class="card-body"><div class="stat-main"><div class="stat-icon-bg bg-warning"><i class="bi bi-bag-check-fill"></i></div><div class="stat-info ms-2"><p class="stat-value text-warning" id="orderThisWeek">Rp 0</p><p class="stat-label">Order Sukses</p></div></div></div></div>
          </div>
        </div>
      </div>
    </div>

    <div id="globalHistory" class="main-section">
        <h3 class="page-title"><i class="bi bi-archive"></i>Global History Semua User</h3>
        <div class="card">
            <div class="card-header">Riwayat Transaksi Seluruh Pengguna</div>
            <div class="card-body">
                <div class="row mb-3 gy-2">
                    <div class="col-lg-8 col-md-7">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="globalHistorySearchInput" class="form-control form-control-sm" placeholder="Cari layanan, username, reff_id, atau target...">
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-5">
                        <select id="globalHistoryCategoryFilter" class="form-select form-select-sm">
                            <option value="">Semua Kategori</option>
                            <option value="Deposit">Deposit</option>
                            <option value="Order">Order</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-striped align-middle data-table">
                        <thead class="table-light">
                            <tr><th>Tanggal</th><th>Username</th><th>Aktivitas</th><th>Nominal/Harga</th><th>Status</th><th>Reff ID</th></tr>
                        </thead>
                        <tbody id="globalHistoryTableBody"></tbody>
                    </table>
                </div>
                <div id="globalHistoryPagination" class="mt-3 d-flex justify-content-center"></div>
            </div>
        </div>
    </div>

  </div>
</div>

<div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="userDetailModalLabel"><i class="bi bi-person-lines-fill me-2 text-primary"></i>Detail Pengguna</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4" id="userDetailModalBody">
        <div class="text-center" id="userDetailLoading" style="padding: 2rem 0;">
          <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">Loading...</span></div>
          <p class="mt-2 text-muted">Memuat detail pengguna...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Tutup</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let allUsersData = [];
  let userDetailModalInstance = null;
  let depositChartInstance = null;
  let orderChartInstance = null;
  let globalHistoryCurrentPage = 1;
  const GLOBAL_HISTORY_ITEMS_PER_PAGE = 20;
  let userTableCurrentPage = 1;
  const USER_TABLE_ITEMS_PER_PAGE = 10;

  const toggleSidebar = () => {
    const s = document.getElementById('sidebar'), o = document.getElementById('overlay');
    s.classList.toggle('show');
    o.classList.toggle('show');
  };

  const showSection = (id) => {
    document.querySelectorAll('.main-section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.sidebar ul li').forEach(l => l.classList.remove('active-link'));
    document.getElementById(`nav-${id}`).classList.add('active-link');
    if (window.innerWidth <= 992 && document.getElementById('sidebar').classList.contains('show')) toggleSidebar();
    
    if (id === 'dashboard') loadDashboardStats();
    if (id === 'users') loadUsersTable(1);
    if (id === 'transaksi') { loadTransaksiData(); renderTransactionCharts(); }
    if (id === 'globalHistory') loadGlobalHistory(1);
  };

  const logout = () => { window.location.href = '/auth/logout'; };
  const formatRupiah = (val) => {
    if (val === undefined || val === null || isNaN(Number(val))) return 'Rp 0';
    return `Rp ${Number(val).toLocaleString('id-ID')}`;
  };
  const getDateStr = (d) => d.toISOString().split('T')[0];
  const formatTanggalIndo = (iso, withTime = true) => {
    if (!iso) return 'N/A';
    try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return 'Tgl Invalid';
        const options = { day: '2-digit', month: 'short', year: 'numeric' };
        if (withTime) {
            options.hour = '2-digit';
            options.minute = '2-digit';
        }
        return d.toLocaleString('id-ID', options).replace(/\./g, ':');
    } catch (e) {
        return 'Err Tgl';
    }
  };

  const fetchDataAndInitialize = async () => {
    try {
        const response = await fetch('/data/users');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        allUsersData = await response.json();
        const currentActiveSection = document.querySelector('.sidebar ul li.active-link')?.id.replace('nav-', '') || 'dashboard';
        showSection(currentActiveSection);
    } catch (e) {
        document.body.innerHTML = `<div class="alert alert-danger m-5">Gagal memuat data dari server. Silakan refresh halaman. Error: ${e.message}</div>`;
    }
  };
  
  const loadDashboardStats = () => {
    if (!allUsersData.length) return;
    
    let verifiedCount = 0;
    let totalSaldo = 0;
    allUsersData.forEach(u => {
        if (u.isVerified) verifiedCount++;
        totalSaldo += u.saldo || 0;
    });

    document.getElementById('totalUsersCount').textContent = allUsersData.length;
    document.getElementById('verifiedUsersCount').textContent = verifiedCount;
    document.getElementById('unverifiedUsersCount').textContent = allUsersData.length - verifiedCount;
    document.getElementById('totalSaldoAllUsers').textContent = formatRupiah(totalSaldo);
  };
  
  const renderPagination = (containerId, totalItems, currentPage, itemsPerPage, callback) => {
    const pc = document.getElementById(containerId);
    if (!pc) return;
    pc.innerHTML = '';
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (totalPages <= 1) return;

    const ul = document.createElement('ul');
    ul.className = 'pagination pagination-sm';

    const createPageItem = (pageNum, text, isActive = false, isDisabled = false) => {
        const li = document.createElement('li');
        li.className = `page-item ${isActive ? 'active' : ''} ${isDisabled ? 'disabled' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.innerHTML = text;
        if (!isDisabled && pageNum !== 0) {
            a.onclick = (e) => {
                e.preventDefault();
                callback(pageNum);
            };
        }
        li.appendChild(a);
        return li;
    };

    ul.appendChild(createPageItem(currentPage - 1, '«', false, currentPage === 1));
    
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    if (totalPages <= 5) {
        startPage = 1;
        endPage = totalPages;
    } else {
        if (currentPage <= 3) endPage = 5;
        else if (currentPage >= totalPages - 2) startPage = totalPages - 4;
    }

    if (startPage > 1) {
        ul.appendChild(createPageItem(1, '1'));
        if (startPage > 2) ul.appendChild(createPageItem(0, '...', false, true));
    }

    for (let i = startPage; i <= endPage; i++) {
        ul.appendChild(createPageItem(i, i, i === currentPage));
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) ul.appendChild(createPageItem(0, '...', false, true));
        ul.appendChild(createPageItem(totalPages, totalPages));
    }

    ul.appendChild(createPageItem(currentPage + 1, '»', false, currentPage === totalPages));
    pc.appendChild(ul);
  };

  const loadUsersTable = (page = 1) => {
    userTableCurrentPage = page;
    const tbody = document.getElementById('userTableBody');
    if (!tbody) return;
    
    if (!allUsersData.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Memuat data pengguna...</td></tr>`;
        return;
    }

    const searchValue = document.getElementById('userSearchInput')?.value.toLowerCase() || '';
    const roleValue = document.getElementById('userRoleFilter')?.value || '';
    
    const filteredUsers = allUsersData.filter(u => 
      (!roleValue || u.role === roleValue) &&
      (!searchValue || 
        (u.username && u.username.toLowerCase().includes(searchValue)) || 
        (u.fullname && u.fullname.toLowerCase().includes(searchValue)) || 
        (u.email && u.email.toLowerCase().includes(searchValue))
      )
    );

    const startIndex = (page - 1) * USER_TABLE_ITEMS_PER_PAGE;
    const endIndex = startIndex + USER_TABLE_ITEMS_PER_PAGE;
    const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
    
    tbody.innerHTML = '';
    if (paginatedUsers.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Tidak ada pengguna yang cocok dengan kriteria.</td></tr>`;
    } else {
      paginatedUsers.forEach((u, index) => {
        const roleBadge = u.role === 'admin' ? 'danger' : (u.role === 'reseller' ? 'info' : 'primary');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${startIndex + index + 1}</td>
          <td>${u.fullname || 'N/A'}</td>
          <td><strong>${u.username}</strong><br><small class="text-muted">Saldo: ${formatRupiah(u.saldo || 0)}</small></td>
          <td>${u.email || 'N/A'}</td>
          <td><span class="badge text-bg-${roleBadge}">${u.role || 'user'}</span></td>
          <td><span class="badge ${u.isVerified ? 'text-bg-success' : 'text-bg-warning'}">${u.isVerified ? '<i class="bi bi-check-circle me-1"></i>Verified' : '<i class="bi bi-hourglass-split me-1"></i>Pending'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1 py-1 px-2" onclick="showUserDetail('${u._id}')" title="Detail"><i class="bi bi-eye-fill"></i></button>
            ${!u.isVerified ? `<button class="btn btn-sm btn-outline-success py-1 px-2" onclick="verifyUser('${u.username}')" title="Verifikasi"><i class="bi bi-patch-check-fill"></i></button>` : ''}
          </td>`;
        tbody.appendChild(tr);
      });
    }
    renderPagination('userTablePagination', filteredUsers.length, page, USER_TABLE_ITEMS_PER_PAGE, loadUsersTable);
  };
  
  const calculateTransactionsForPeriod = (type, startDate, endDate) => {
      let total = 0;
      const start = new Date(startDate); start.setHours(0,0,0,0);
      const end = new Date(endDate); end.setHours(23,59,59,999);
      
      allUsersData.forEach(user => {
          const historySource = type === 'Deposit' ? user.historyDeposit : user.historyOrder;
          if(historySource && Array.isArray(historySource)){
              historySource.forEach(h => {
                  const hDate = new Date(h.created_at);
                  if (h.status.toLowerCase() === 'success' && hDate >= start && hDate <= end) {
                      const amount = type === 'Deposit' ? h.get_balance : h.price;
                      total += amount || 0;
                  }
              });
          }
      });
      return total;
  };

  const loadTransaksiData = () => {
    if (!allUsersData.length) return;
    const today = new Date();
    const todayStr = getDateStr(today);
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - 6);
    const weekStartStr = getDateStr(weekStart);

    document.getElementById('depositToday').textContent = formatRupiah(calculateTransactionsForPeriod('Deposit', todayStr, todayStr));
    document.getElementById('orderToday').textContent = formatRupiah(calculateTransactionsForPeriod('Order', todayStr, todayStr));
    document.getElementById('depositThisWeek').textContent = formatRupiah(calculateTransactionsForPeriod('Deposit', weekStartStr, todayStr));
    document.getElementById('orderThisWeek').textContent = formatRupiah(calculateTransactionsForPeriod('Order', weekStartStr, todayStr));
  };
  
  const aggregateDataForChart = (days, type) => {
    const dataMap = {};
    const today = new Date();
    for (let i = 0; i < days; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        dataMap[getDateStr(d)] = 0;
    }
    
    allUsersData.forEach(user => {
        const historySource = type === 'Deposit' ? user.historyDeposit : user.historyOrder;
        if (historySource && Array.isArray(historySource)) {
            historySource.forEach(h => {
                if (h.status.toLowerCase() === 'success') {
                    const hDateStr = getDateStr(new Date(h.created_at));
                    if (dataMap.hasOwnProperty(hDateStr)) {
                        const amount = type === 'Deposit' ? h.get_balance : h.price;
                        dataMap[hDateStr] += amount || 0;
                    }
                }
            });
        }
    });

    const labels = Object.keys(dataMap).sort((a, b) => new Date(a) - new Date(b));
    const data = labels.map(label => dataMap[label]);
    return { labels: labels.map(l => formatTanggalIndo(l, false)), data };
  };

  const renderTransactionCharts = () => {
    if (!allUsersData.length) return;

    const depositChartData = aggregateDataForChart(7, 'Deposit');
    const orderChartData = aggregateDataForChart(7, 'Order');

    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, ticks: { callback: v => formatRupiah(v).replace('Rp ', '') } } },
        plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatRupiah(c.raw)}` } } }
    };

    const depositCtx = document.getElementById('depositChart');
    if (depositCtx) {
        if (depositChartInstance) depositChartInstance.destroy();
        depositChartInstance = new Chart(depositCtx, { type: 'line', data: { labels: depositChartData.labels, datasets: [{ label: 'Deposit', data: depositChartData.data, borderColor: '#3498db', backgroundColor: 'rgba(52,152,219,0.1)', tension: 0.3, fill: true }] }, options: chartOptions });
    }
    const orderCtx = document.getElementById('orderChart');
    if (orderCtx) {
        if (orderChartInstance) orderChartInstance.destroy();
        orderChartInstance = new Chart(orderCtx, { type: 'line', data: { labels: orderChartData.labels, datasets: [{ label: 'Order', data: orderChartData.data, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', tension: 0.3, fill: true }] }, options: chartOptions });
    }
  };
  
  const showUserDetail = (userId) => {
    const user = allUsersData.find(u => u._id === userId);
    const modalBody = document.getElementById('userDetailModalBody');
    const modalTitle = document.getElementById('userDetailModalLabel');
    const loadingDiv = document.getElementById('userDetailLoading');

    modalBody.innerHTML = '';
    loadingDiv.style.display = 'block';
    modalBody.appendChild(loadingDiv);
    
    if (!userDetailModalInstance) userDetailModalInstance = new bootstrap.Modal(document.getElementById('userDetailModal'));
    userDetailModalInstance.show();

    if (user) {
      modalTitle.textContent = `Detail Pengguna: ${user.username || 'N/A'}`;
      
      let historyHtml = '<p class="text-center text-muted small my-3">Tidak ada riwayat transaksi.</p>';
      const combinedHistory = [
          ...(user.historyDeposit || []).map(h => ({ ...h, type: 'Deposit', amount: h.get_balance, date: h.created_at, ref: h.reff_id, details: `${h.metode} - ${h.bank}` })),
          ...(user.historyOrder || []).map(h => ({ ...h, type: 'Order', amount: h.price, date: h.created_at, ref: h.reff_id, details: h.layanan })),
      ].sort((a, b) => new Date(b.date) - new Date(a.date));

      if (combinedHistory.length > 0) {
        historyHtml = `<div class="table-responsive mt-3 border rounded" style="max-height:350px;overflow-y:auto;"><table class="table table-sm table-striped table-bordered table-hover mb-0"><thead class="table-light sticky-top"><tr><th>Tanggal</th><th>Tipe</th><th>Detail</th><th>Jumlah</th><th>Status</th><th>Reff ID</th></tr></thead><tbody>`;
        combinedHistory.forEach(h => {
          let amountColor = h.type === 'Deposit' ? 'text-success' : 'text-danger';
          let statusBadge = h.status.toLowerCase() === 'success' ? 'success' : (h.status.toLowerCase() === 'failed' || h.status.toLowerCase() === 'error' ? 'danger' : 'warning');
          historyHtml += `
            <tr>
              <td>${formatTanggalIndo(h.date)}</td>
              <td><span class="badge text-bg-${h.type === 'Deposit' ? 'info' : 'primary'}">${h.type}</span></td>
              <td>${h.details || 'N/A'}</td>
              <td class="fw-bold ${amountColor}">${formatRupiah(h.amount)}</td>
              <td><span class="badge text-bg-${statusBadge}">${h.status}</span></td>
              <td><small class="text-muted">${h.ref || 'N/A'}</small></td>
            </tr>`;
        });
        historyHtml += `</tbody></table></div>`;
      }
      
      const detailContent = `
        <div class="row g-4">
          <div class="col-lg-3 text-center">
            <img src="${user.profileUrl || 'https://i.pinimg.com/236x/a2/80/e2/a280e2a50bf6240f29b49a72875adee5.jpg'}" class="img-fluid rounded-circle mb-2 shadow-sm" alt="Foto Profil" style="width:120px;height:120px;object-fit:cover;">
            <h5 class="mb-0">${user.fullname || 'Anonim'}</h5>
            <p class="text-muted small mb-1">@${user.username}</p>
            <span class="badge bg-${user.role === 'admin' ? 'danger' : 'primary'} rounded-pill">${user.role || 'user'}</span>
          </div>
          <div class="col-lg-9">
            <h6 class="mb-3 text-primary"><i class="bi bi-info-circle-fill me-2"></i>Informasi Akun</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-envelope me-2 text-muted"></i>Email</span><strong class="text-dark">${user.email || 'N/A'}</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-phone me-2 text-muted"></i>No. HP</span><strong class="text-dark">${user.nomor || 'N/A'}</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-wallet2 me-2 text-muted"></i>Saldo</span><strong class="text-success fw-bolder">${formatRupiah(user.saldo)}</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-coin me-2 text-muted"></i>Koin</span><strong class="text-warning fw-bolder">${user.coin || 0}</strong></li>
                </ul>
              </div>
              <div class="col-md-6 mb-3">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-patch-check me-2 text-muted"></i>Verified</span><span class="badge text-bg-${user.isVerified ? 'success' : 'danger'}">${user.isVerified ? 'Ya' : 'Tidak'}</span></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-calendar-plus me-2 text-muted"></i>Daftar</span><small class="text-dark">${formatTanggalIndo(user.tanggalDaftar)}</small></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-clock me-2 text-muted"></i>Login Akhir</span><small class="text-dark">${formatTanggalIndo(user.lastLogin)}</small></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-award me-2 text-muted"></i>Ref. Code</span><strong class="text-dark">${user.referralCode || 'N/A'}</strong></li>
                </ul>
              </div>
            </div>
            <h6 class="mt-2 mb-1 text-primary"><i class="bi bi-key-fill me-2"></i>API Key</h6>
            <p class="user-select-all bg-light p-2 rounded font-monospace small" style="word-break:break-all;">${user.apiKey || 'N/A'}</p>
             <h6 class="mt-2 mb-1 text-primary"><i class="bi bi-shield-lock me-2"></i>Whitelist IP</h6>
            <p class="bg-light p-2 rounded font-monospace small">${(user.whitelistIp || ['N/A']).join(', ')}</p>
          </div>
        </div>
        <hr class="my-4">
        <h6 class="mb-3 text-primary"><i class="bi bi-list-ul me-2"></i>Riwayat Transaksi (Terbaru)</h6>
        ${historyHtml}`;
      
      loadingDiv.style.display = 'none';
      modalBody.innerHTML = detailContent;
    } else {
      modalTitle.textContent = 'User Tidak Ditemukan';
      loadingDiv.style.display = 'none';
      modalBody.innerHTML = `<p class="text-danger text-center py-4">Detail user dengan ID ${userId} tidak dapat ditemukan.</p>`;
    }
  };

  const verifyUser = async (username) => {
    if (!confirm(`Apakah Anda yakin ingin memverifikasi pengguna: ${username}?`)) return;
    try {
      const response = await fetch('/admin/verify-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: username })
      });
      const result = await response.json();
      alert(result.message || (result.success ? `Pengguna ${username} berhasil diverifikasi.` : 'Gagal melakukan verifikasi.'));
      if (result.success) await fetchDataAndInitialize();
    } catch (e) {
      alert('Terjadi kesalahan saat mencoba verifikasi pengguna.');
    }
  };
  
  const loadGlobalHistory = (page = 1) => {
    globalHistoryCurrentPage = page;
    const tbody = document.getElementById('globalHistoryTableBody');
    if (!tbody) return;

    if (!allUsersData.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">Memuat riwayat transaksi...</td></tr>`;
      return;
    }
    
    const searchValue = document.getElementById('globalHistorySearchInput').value.toLowerCase();
    const categoryValue = document.getElementById('globalHistoryCategoryFilter').value;

    let flatHistory = [];
    allUsersData.forEach(user => {
        (user.historyDeposit || []).forEach(h => flatHistory.push({ ...h, username: user.username, type: 'Deposit', amount: h.get_balance, date: h.created_at, ref: h.reff_id, details: h.layanan || h.metode }));
        (user.historyOrder || []).forEach(h => flatHistory.push({ ...h, username: user.username, type: 'Order', amount: h.price, date: h.created_at, ref: h.reff_id, details: h.layanan }));
    });
    flatHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

    const filteredHistory = flatHistory.filter(h => {
        const matchCategory = !categoryValue || h.type === categoryValue;
        const matchSearch = !searchValue || 
            (h.details && h.details.toLowerCase().includes(searchValue)) ||
            (h.username && h.username.toLowerCase().includes(searchValue)) ||
            (h.ref && h.ref.toLowerCase().includes(searchValue)) ||
            (h.target && h.target.toLowerCase().includes(searchValue));
        return matchCategory && matchSearch;
    });

    const startIndex = (page - 1) * GLOBAL_HISTORY_ITEMS_PER_PAGE;
    const paginatedHistory = filteredHistory.slice(startIndex, startIndex + GLOBAL_HISTORY_ITEMS_PER_PAGE);

    tbody.innerHTML = '';
    if (paginatedHistory.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">Tidak ada riwayat yang cocok.</td></tr>`;
    } else {
      paginatedHistory.forEach(h => {
        const statusBadge = h.status.toLowerCase() === 'success' ? 'success' : (h.status.toLowerCase() === 'failed' || h.status.toLowerCase() === 'error' ? 'danger' : 'warning');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatTanggalIndo(h.date)}</td>
            <td>${h.username}</td>
            <td>${h.details || 'N/A'}</td>
            <td>${formatRupiah(h.amount)}</td>
            <td><span class="badge text-bg-${statusBadge}">${h.status}</span></td>
            <td><small class="text-muted">${h.ref || 'N/A'}</small></td>`;
        tbody.appendChild(tr);
      });
    }
    renderPagination('globalHistoryPagination', filteredHistory.length, page, GLOBAL_HISTORY_ITEMS_PER_PAGE, loadGlobalHistory);
  };


  document.addEventListener('DOMContentLoaded', async () => {
    await fetchDataAndInitialize();
    
    document.getElementById('globalHistorySearchInput')?.addEventListener('input', () => loadGlobalHistory(1));
    document.getElementById('globalHistoryCategoryFilter')?.addEventListener('change', () => loadGlobalHistory(1));
    document.getElementById('userSearchInput')?.addEventListener('input', () => loadUsersTable(1));
    document.getElementById('userRoleFilter')?.addEventListener('change', () => loadUsersTable(1));
    
    window.addEventListener('resize', () => {
        if (depositChartInstance) depositChartInstance.resize();
        if (orderChartInstance) orderChartInstance.resize();
    });
  });
</script>
</body>
</html>
